name: ri-aggregation CI
on:
  push:
    branches:
    - master
  #workflow_dispatch:
  
jobs:
  unit-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          ref: master
        
      - name: start-services
        run: |
          docker-compose -f docker-compose-runner.yml down
          docker-compose -f docker-compose-runner.yml pull
          #docker-compose -f docker-compose-runner.yml build rskj
          #docker run -d -p 4444:4444 -p 4445:4445 --name rskj ri-aggregation_rskj:latest
          #echo 'Started rskj and test RPC after 10 seconds'
          #sleep 10s
          #curl http://localhost:4444 -X POST -H "Content-Type: application/json" --data '{"jsonrpc":"2.0","method":"eth_blockNumber","params":[],"id":1}'  
      
      - name: continue-starting-services    
        run: |  
          docker-compose -f docker-compose-runner.yml up -d rskj postgres zk 
          ci_run sccache --start-server &
          docker-compose -f docker-compose-runner.yml ps -a
          #remove the rskj container and launch a new one manually
          #ci_run docker stop ri-aggregation_rskj_1
          #ci_run docker rm ri-aggregation_rskj_1
          #ci_run docker run -d -p 4444:4444 -p 4445:4445 --name rskj ri-aggregation_rskj:latest
          #ci_run echo 'Started rskj manually. Test RPC after 5 seconds'
          #ci_run sleep 5s
          ci_run curl http://localhost:4444 -X POST -H "Content-Type: application/json" --data '{"jsonrpc":"2.0","method":"eth_blockNumber","params":[],"id":1}'  

      
      - name: setup-env
        run: |
          echo ZKSYNC_HOME=$(pwd) >> $GITHUB_ENV
          echo $(pwd)/bin >> $GITHUB_PATH
      
      - name: init
        run: |
          ci_run ln -s /usr/src/keys/setup keys/setup
          ci_run zk
          ci_run zk run verify-keys unpack
          ci_run zk contract build
          ci_run zk db basic-setup
          ci_run zk run yarn

      - name: run-contract-tests
        run: |
          ci_rskj_run zk run deploy-erc20 dev
          ci_rskj_run zk run deploy-eip1271

      - name: restart dev-liquidity-token-watcher and dev-ticker
        run: docker-compose -f docker-compose-runner.yml restart dev-liquidity-token-watcher dev-ticker

      - name: contracts-unit-tests
        run: ci_run zk test contracts

      - name: js-unit-tests
        run: ci_run zk test js

      #- name: rust-unit-tests
      #  run: ci_run zk test server-rust
        
